name: ğŸš€ æäº¤  release/** æˆ– master åˆ†æ”¯åéƒ¨ç½²åˆ°ç›¸åº”æœåŠ¡å™¨
# 1
on:
  push:
    branches:
      - 'release/**'
      - master

jobs:
  deploy-master:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    # é»˜è®¤ä¸ºæµ‹è¯•ç¯å¢ƒ 2
    env:
      mode: test
      server_ip: 47.98.59.211
      server_port: 5243
      build_script: 'build'
      project_url: 'http://47.98.59.211:5285/'
      server_dir: './IISSites-TY/CF.Mould.OpenApi/Android/'
    steps:
      - name: Get current time for start
        uses: 1466587594/get-current-time@v2
        id: current-time-start
        with:
          format: 'YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss'
          utcOffset: '+08:00'


      #      - name: æµ‹è¯•ç¯å¢ƒè·å–ç‰ˆæœ¬å·
      #        id: jira
      #        uses: AsasInnab/regex-action@v1
      #        with:
      #          regex_pattern: 'v.+'
      #          search_string: '${{ github.}}'

      #      å¦‚æœæ˜¯æ­£å¼ç¯å¢ƒ, åˆ™ä¿®æ”¹å˜é‡
      - name: ä¸ºæ­£å¼ç¯å¢ƒè®¾ç½®ç¯å¢ƒå˜é‡
        if: ${{ startsWith(github.ref, 'refs/heads/master') }}
        run: |
          echo "mode=production" >> $GITHUB_ENV
          echo "server_ip=47.98.150.98" >> $GITHUB_ENV
          echo "server_port=5262" >> $GITHUB_ENV
          echo "build_script=build" >> $GITHUB_ENV
          echo "project_url=http://47.98.59.211:5241/" >> $GITHUB_ENV
          echo "server_dir=./CF.WDPractice.Gateway.Page.Vue/" >> $GITHUB_ENV

      - name: ğŸšš Get latest code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šæœ‰tag, ä¸ºäº†è·å–tagéœ€è¦æŒ‡å®šæ·±åº¦ä¸º0 è·å–æ‰€æœ‰çš„, ä¸èƒ½ç”¨æ•°å€¼

      #     è·å–æ ‡ç­¾, å³ç‰ˆæœ¬å·
      #  TODO æµ‹è¯•ç¯å¢ƒåº”è¯¥è·å–releaseåé¢çš„æ•°å­—...
      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
        with:
          fallback: 1.0.0

      - name: å¼€å§‹æ—¶é€šçŸ¥é£ä¹¦
        uses: distributhor/workflow-webhook@v2
        with:
          verify_ssl: false
        env:
          webhook_url: https://www.feishu.cn/flow/api/trigger-webhook/13252e23a8613c2f41933e1413024dd3
          webhook_secret: 'zkc'
          data: '{ "status": "start", "tag": "${{ steps.previoustag.outputs.tag }}", "time":"${{ steps.current-time-start.outputs.formattedTime }}",  "github": ${{ toJSON(github) }},"url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'


      - name: Use Node.js 12
        uses: actions/setup-node@v2-beta
        with:
          node-version: '12'

      #      è·å–åˆ†æ”¯å
      #      - uses: nelonoel/branch-name@v1.0.1
      #      - run: echo ${BRANCH_NAME}



      #      - name: Get Changelog Entry
      #        id: changelog_reader
      #        uses: ./.github/workflows/read-changelog
      #        with:
      #          version: 2.2.0

      - name: ğŸ”¨ Build Project
        run: |
          npm install
          npm run ${{ env.build_script }}

      - name: ğŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@4.1.0
        with:
          server: ${{ env.server_ip }}
          username: cfwlftp
          #          NOTE æ³¨æ„githubä¸Šè¦å¡«password!!
          password: ${{ secrets.password }}
          local-dir: ./dist/
          server-dir: ${{ env.server_dir }}
          port: ${{ env.server_port }}
          #          dry-run: true
          exclude: '
            - **/.web.config
            '

      # NOTE éœ€è¦åˆ›å»ºtag !! å°å†™vå¼€å¤´, ä¸èƒ½å¤§å†™, ä¸åˆæ³•çš„semver
      #      - name: åˆ›å»ºæ›´æ”¹æ—¥å¿—(æ­£å¼ç¯å¢ƒ)
      #        id: github_release
      #        uses: heinrichreimer/github-changelog-generator-action@v2.1.1
      #        with:
      #          token: ${{ secrets.GITHUB_TOKEN }}



      - name: Get current time
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss'
          utcOffset: '+08:00'
      #
      #      NOTE æš‚æ—¶ä¸åšäº†, ä»¥åæœ‰ç©ºè‡ªå·±å†™ä¸ªactionè®¡ç®—æ‰€ç”¨æ—¶é—´
      #      - name: è®¡ç®—æ‰€ç”¨æ—¶é—´
      #        shell: bash
      #        run: |
      #          echo `expr  $FIRST_NAME -  $FIRST_NAME` >> $GITHUB_ENV
      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—è¿æ¥
        uses: bluwy/substitute-string-action@v1
        id: changelog_url
        with:
          _input-text: 'https://github.com/kyingfu0/wenzhou-university-practice-base/blob/%%sha%%/CHANGELOG.md'
          _format-key: '%%sha%%'
          sha: ${{ github.sha }}


      - name: æˆåŠŸåé€šçŸ¥é£ä¹¦
        if: ${{ success() }}
        uses: distributhor/workflow-webhook@v2
        with:
          verify_ssl: false
        env:
          webhook_url: https://www.feishu.cn/flow/api/trigger-webhook/13252e23a8613c2f41933e1413024dd3
          webhook_secret: 'zkc'
          data: '{ "status": "success", "tag": "${{ steps.previoustag.outputs.tag }}", "project_url": "${{env.project_url}}", "time":"${{ steps.current-time.outputs.formattedTime }}", "github": ${{ toJSON(github) }},"url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "changelog_url": "${{ steps.changelog_url.outputs.result }}"}'

      - name: å¤±è´¥åé€šçŸ¥é£ä¹¦
        if: ${{ failure() }}
        uses: distributhor/workflow-webhook@v2
        with:
          verify_ssl: false
        env:
          webhook_url: https://www.feishu.cn/flow/api/trigger-webhook/13252e23a8613c2f41933e1413024dd3
          webhook_secret: 'zkc'
          data: '{ "status": "fail", "tag": "${{ steps.previoustag.outputs.tag }}", "project_url": "${{env.project_url}}", "time":"${{ steps.current-time.outputs.formattedTime }}", "github": ${{ toJSON(github) }},"url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",  "changelog_url": "${{ steps.changelog_url.outputs.result }}"}'
